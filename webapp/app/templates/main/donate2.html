{% import 'macros/page_macros.html' as page %}
{% import 'macros/form_macros.html' as f %}
{% extends 'layouts/base.html' %}

{% block content %}
  <div class="Site-content ui text container">
<!--    <div class="eight wide computer sixteen wide mobile centered column"> -->
      <noscript>You need to enable JavaScript to run this app.</noscript>
      <div id="donateRoot">
          <h2>Hotspot your mole</h2>
      </div>
      
      {% set flashes = {
          'error':   get_flashed_messages(category_filter=['form-error']),
          'warning': get_flashed_messages(category_filter=['form-check-email']),
          'info':    get_flashed_messages(category_filter=['form-info']),
          'success': get_flashed_messages(category_filter=['form-success'])
      } %}

      {{ f.begin_form(form, flashes) }}

      <div class="moletab 0">
        <h2>Info Heading</h2>
        {{ lipsum(2) }}
      </div>

      <div class="moletab 1">
        <h2>Take a Picture</h2>
        {{ lipsum(1) }}
        {{ f.render_form_field(form.image) }}
        <img class="center" id="imgpreview" src="#" alt="Upload" />
      </div>

      <div class="moletab 2 bodyTab">
        
        {{ f.render_form_field(form.body_location) }}
        {{ f.render_form_field(form.body_image) }}
      </div>

      <div class="moletab 3">
        <h2>Confirm</h2>
        {{ lipsum(1) }}
        <button onclick="newMole()" class="ui primary fluid button">Donate another Mole</button>
      </div>

      <div class="moletab 4">
        <h2>Help us complete the picture</h2>
        {{ f.render_form_field(form.age) }}
        {{ f.render_form_field(form.sex) }}
        {{ f.render_form_field(form.location) }}

        <div class="field  ">
          <input id="search-address" type="text" placeholder="Enter postcode or suburbâ€¦">
          <i class="globabl icon"></i>
        </div>

        {{ f.render_form_field(form.ancestry) }}

      </div>

      <div class="moletab 5">
          <h2>Almost there!</h2>

          {{ f.render_form_field(form.personal_history) }}
          {{ f.render_form_field(form.family_history) }}
          {{ f.render_form_field(form.pathology) }}
  
        </div>

      <div class="moletab 6">
        <h2>Consent</h2>
        {{ lipsum(1) }}
        
        <button onclick="nextPrev(1)" class="ui primary fluid button">I Disagree</button>
      </div>

      <div class="moletab 7">
        <h2>Thank you</h2>
        {{ lipsum(1) }}
        <h4>Share</h4>
      </div>

      {{ f.end_form(form) }}
          
    </div>
  </div>

  <footer style="text-align:center;margin-top:40px;margin-bottom:10px;">
    <div class="ui text container">
      <button id="footerBtn" onclick="nextProcess()" class="ui primary fluid button">Next</button>
    </div>
  </footer>
  <!-- Circles which indicates the steps of the form: -->
  <footer style="text-align:center;margin-top:10px;margin-bottom:40px;">
    <span class="step"></span>
    <span class="step"></span>
    <span class="step"></span>
    <span class="step"></span>
    <span class="step"></span>
    <span class="step"></span>
    <span class="step"></span>
    <span class="step"></span>
  </footer>

<script>
  var currentTab = 0; // Current tab is set to be the first tab (0)
  prepTab(currentTab); // Display the current tab

  function newMole() {
    /// blah
    nextPrev(-2)
  }

  function nextProcess() {
    nextPrev(1);
  }

  function prepTab(n) {
    $(".moletab."+n)
      .transition('horizontal flip', '500ms')
      .delay(1000)
    ;
    fixStepIndicator(n)
  }

  function showTab(n) {
    // This function will display the specified tab of the form ...
    //var x = document.getElementsByClassName("moletab");
    //x[n].style.display = "block";
    $(".moletab."+n)
      .delay(2000)
      .transition('horizontal flip', '500ms')
      //.css("display", "block")
    ;
    if (n == 2) $("#donateRoot")
      .transition('horizontal flip', '100ms')
    ;
    // else set 
    // ... and run a function that displays the correct step indicator:
    fixStepIndicator(n)
  }

  function nextPrev(n) {
    // This function will figure out which tab to display
    var x = document.getElementsByClassName("moletab");
    // Exit the function if any field in the current tab is invalid:
    if (n == 1 && !validateForm()) return false;
    // Hide the current tab:
    //x[currentTab].style.display = "none";
    $(".moletab."+currentTab)
      .transition('horizontal flip')
    ;
    if (currentTab == 2) $("#donateRoot")
      .transition('horizontal flip', '100ms')
    ;
    // Increase or decrease the current tab by 1:
    currentTab = currentTab + n;
    // if you have reached the end of the form... :
    if (currentTab >= x.length) {
      return false;
    }
    // Otherwise, display the correct tab:
    showTab(currentTab);
  }

  function validateForm() {
    // This function deals with validation of the form fields
    var x, y, i, valid = true;
    x = document.getElementsByClassName("moletab");
    y = x[currentTab].getElementsByTagName("input");
    // A loop that checks every input field in the current tab:
    for (i = 0; i < y.length; i++) {
      // If a field is empty...
      if (y[i].value == "") {
        // add an "invalid" class to the field:
        y[i].className += " invalid";
        // and set the current valid status to false:
        valid = false;
      }
    }
    // If the valid status is true, mark the step as finished and valid:
    if (valid) {
      document.getElementsByClassName("step")[currentTab].className += " finish";
    }
    return valid; // return the valid status
  }

  function fixStepIndicator(n) {
    // This function removes the "active" class of all steps...
    var i, x = document.getElementsByClassName("step");
    for (i = 0; i < x.length; i++) {
      x[i].className = x[i].className.replace(" active", "");
    }
    //... and adds the "active" class to the current step:
    x[n].className += " active";
  }
</script>
<script>
    function previewImg(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        
        reader.onload = function(e) {
          $('#imgpreview').attr('src', e.target.result);
        }
        
        reader.readAsDataURL(input.files[0]);
      }
    }
    
    $("#image").change(function() {
      previewImg(this);
    });
</script>
<script src="{{ url_for('static', filename='donate/donate_bundle.js') }}"></script>
{% endblock %}
